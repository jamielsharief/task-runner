#!/usr/bin/env php
<?php

$buildRoot = dirname(__DIR__);
$output = $buildRoot . '/bin/task.phar';

if (file_exists($output)) {
    unlink($output);
}

chdir($buildRoot);

shell_exec('composer update -q --no-dev');

$phar = new Phar($output, 0, 'task.phar');
$phar->setSignatureAlgorithm(Phar::SHA1);

$phar->startBuffering();
$phar->buildFromDirectory($buildRoot . '/src', '/^.*\.(php|json)$/i');
$phar->buildFromDirectory($buildRoot . '/vendor', '/^.*\.(php|json)$/i');

// Shebang is not being stripped on PHP 7.4.12, so manually doing this
$phar->addFromString(
    'bin/task',
    preg_replace('/^#!\/usr\/bin\/env php\R/', '', file_get_contents($buildRoot . '/bin/task'))
);

// Modify the version

$version = shell_exec('git describe --tags --exact-match HEAD 2>&1');
$version = preg_match('/^([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9a-z-])+)?$/i', $version) ? $version : 'unkown';
$phar->addFromString(
    'src/Command/TaskCommand.php',
    preg_replace('/{{task_version}}/', $version, file_get_contents($buildRoot . '/src/Command/TaskCommand.php'))
);

$phar->setStub("#!/usr/bin/env php\n". $phar->createDefaultStub('bin/task'));
$phar->stopBuffering();

$phar->compressFiles(Phar::GZ);

chmod($output, 0755);
echo('[OK] bin/task.phar created now' . PHP_EOL);
